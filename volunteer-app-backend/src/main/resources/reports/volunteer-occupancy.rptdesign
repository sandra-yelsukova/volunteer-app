<?xml version="1.0" encoding="UTF-8"?>
<report xmlns="http://www.eclipse.org/birt/2005/design" version="3.2.22" id="1">
    <property name="createdBy">Volunteer App</property>
    <property name="units">mm</property>
    <data-sources>
        <oda-data-source
            extensionID="org.eclipse.birt.report.data.oda.jdbc"
            name="VolunteerDB"
            id="2">

            <property name="odaDriverClass">org.postgresql.Driver</property>
            <property name="odaURL">jdbc:postgresql://localhost:5432/volunteer_db</property>
            <property name="odaUser">postgres</property>

            <encrypted-property name="odaPassword">cG9zdGdyZXM=</encrypted-property>

        </oda-data-source>
    </data-sources>
    <data-sets>
        <oda-data-set extensionID="org.eclipse.birt.report.data.oda.jdbc.JdbcSelectDataSet" name="VolunteerOccupancy" id="3">
            <list-property name="resultSet">
                <structure>
                    <property name="position">1</property>
                    <property name="name">volunteer_id</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">2</property>
                    <property name="name">full_name</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">3</property>
                    <property name="name">email</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">4</property>
                    <property name="name">total_tasks</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">5</property>
                    <property name="name">active_tasks</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">6</property>
                    <property name="name">completed_tasks</property>
                    <property name="dataType">decimal</property>
                </structure>
            </list-property>
            <property name="queryText"><![CDATA[
SELECT
    u.id AS volunteer_id,
    CONCAT(u.surname, ' ', u.name, ' ', u.patronymic) AS full_name,
    u.email,
    COUNT(t.id) AS total_tasks,
    COUNT(CASE WHEN t.status = 'IN_PROGRESS' THEN 1 END) AS active_tasks,
    COUNT(CASE WHEN t.status = 'DONE' THEN 1 END) AS completed_tasks
FROM users u
LEFT JOIN tasks t
    ON t.assignee_user_id = u.id
WHERE u.role = 'VOLUNTEER'
GROUP BY u.id, u.surname, u.name, u.patronymic, u.email
ORDER BY full_name;
            ]]></property>
            <property name="dataSource">VolunteerDB</property>
        </oda-data-set>
    </data-sets>
    <body>
        <table id="5">
            <property name="dataSet">VolunteerOccupancy</property>
            <list-property name="columnBindings">

                <structure>
                    <property name="name">volunteer_id</property>
                    <property name="dataType">decimal</property>
                    <property name="expression">dataSetRow["volunteer_id"]</property>
                </structure>

                <structure>
                    <property name="name">full_name</property>
                    <property name="dataType">string</property>
                    <property name="expression">dataSetRow["full_name"]</property>
                </structure>

                <structure>
                    <property name="name">email</property>
                    <property name="dataType">string</property>
                    <property name="expression">dataSetRow["email"]</property>
                </structure>

                <structure>
                    <property name="name">total_tasks</property>
                    <property name="dataType">decimal</property>
                    <property name="expression">dataSetRow["total_tasks"]</property>
                </structure>

                <structure>
                    <property name="name">active_tasks</property>
                    <property name="dataType">decimal</property>
                    <property name="expression">dataSetRow["active_tasks"]</property>
                </structure>

                <structure>
                    <property name="name">completed_tasks</property>
                    <property name="dataType">decimal</property>
                    <property name="expression">dataSetRow["completed_tasks"]</property>
                </structure>

            </list-property>
            <column id="6"/>
            <column id="7"/>
            <column id="8"/>
            <column id="9"/>
            <column id="10"/>
            <column id="11"/>
            <header>
                <row id="12">
                    <cell id="13">
                        <label id="14">
                            <text-property name="text">ID волонтёра</text-property>
                        </label>
                    </cell>
                    <cell id="15">
                        <label id="16">
                            <text-property name="text">Волонтёр</text-property>
                        </label>
                    </cell>
                    <cell id="17">
                        <label id="18">
                            <text-property name="text">Email</text-property>
                        </label>
                    </cell>
                    <cell id="19">
                        <label id="20">
                            <text-property name="text">Всего задач</text-property>
                        </label>
                    </cell>
                    <cell id="21">
                        <label id="22">
                            <text-property name="text">Активные задачи</text-property>
                        </label>
                    </cell>
                    <cell id="23">
                        <label id="24">
                            <text-property name="text">Завершенные задачи</text-property>
                        </label>
                    </cell>
                </row>
            </header>
            <detail>
                <row id="25">
                    <cell id="26">
                        <data id="27">
                            <property name="columnBinding">volunteer_id</property>
                        </data>
                    </cell>
                    <cell id="28">
                        <data id="29">
                            <property name="columnBinding">full_name</property>
                        </data>
                    </cell>
                    <cell id="30">
                        <data id="31">
                            <property name="columnBinding">email</property>
                        </data>
                    </cell>
                    <cell id="32">
                        <data id="33">
                            <property name="columnBinding">total_tasks</property>
                        </data>
                    </cell>
                    <cell id="34">
                        <data id="35">
                            <property name="columnBinding">active_tasks</property>
                        </data>
                    </cell>
                    <cell id="36">
                        <data id="37">
                            <property name="columnBinding">completed_tasks</property>
                        </data>
                    </cell>
                </row>
            </detail>
        </table>
    </body>
</report>